= TP - Applications Web avec NodeJS et Express (Version ESM)
Timothée Robert
:toc: left
:toclevels: 3
:sectnums:
:source-highlighter: highlight.js
:imagesdir: images

image::node1.svg[NodeJS Logo]

Ce TP a pour objectif de vous faire créer votre premier serveur web avec NodeJS et le framework Express, en abordant la notion fondamentale de *routage* en utilisant la syntaxe moderne **ES Modules**.

== Architecture d'une application NodeJS

Une application NodeJS s'intègre généralement dans une architecture client-serveur.

image::node2.png[Architecture d'application Node.js]

* **User / Front-end Tech :** Le client peut être une application web (développée avec des frameworks comme React, Vue, Angular) ou une application mobile (iOS, Android).
* **Server :** C'est là que notre code NodeJS s'exécute. Il utilise des librairies comme Express pour gérer les requêtes web. Il communique avec des bases de données (ex: MySQL, MongoDB) et d'autres services.

Le fonctionnement interne de NodeJS est basé sur une **boucle d'événements (Event Loop)** qui s'exécute dans un seul thread. Cela lui permet de gérer de nombreuses connexions simultanément de manière non-bloquante. Les opérations longues (comme un accès à la base de données) sont déléguées et leur résultat est traité plus tard via une fonction de rappel (callback).

image::node3.png[Schéma de l'Event Loop]

== Introduction à Express

Express est un framework minimaliste pour applications web NodeJS. Il fournit une surcouche simple et robuste pour créer des serveurs et des API REST.

image::node4.png[Couches d'une application Express]

Une requête HTTP arrive, Express la dirige vers la bonne **Route**, qui fait appel à un **Contrôleur**. Celui-ci utilise des **Services** (la logique métier) qui peuvent interagir avec des **Modèles** pour accéder aux données (base de données, API externe).

== Le Routage

Le routage est le mécanisme qui détermine comment une application répond à une requête client vers une URL et une méthode HTTP spécifiques (GET, POST, etc.).

=== Un exemple complet avec Express

. *Étape 1 : Installation d'Express*
+
Dans le terminal de votre projet, exécutez la commande :
+
[source,bash]
----
npm install express
----

. *Étape 2 : Configuration du projet en mode ES Module*
+
Pour pouvoir utiliser la syntaxe `import`, vous devez indiquer à NodeJS que votre projet est un "ES Module". Ouvrez votre fichier `package.json` et ajoutez la ligne suivante :
+
[source,json]
----
"type": "module",
----
+
Votre `package.json` devrait ressembler à ceci :
+
[source,json]
----
{
  "name": "mon-projet-express",
  "version": "1.0.0",
  "description": "",
  "main": "routeintro.js",
  "type": "module",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "author": "",
  "license": "ISC",
  "dependencies": {
    "express": "^4.18.2"
  }
}
----

. *Étape 3 : Création du serveur (`routeintro.js`)*
+
Créez un fichier `routeintro.js` avec le code suivant, qui utilise maintenant `import` au lieu de `require`.
+
[source,javascript]
----
// Ligne 1: On importe la librairie express avec la syntaxe ESM
import express from 'express';

// Ligne 2: On crée une instance de l'application Express
const app = express();

const port = 3000;

// Ligne 4: On définit une route pour la racine de l'application
// Elle répondra aux requêtes HTTP GET sur l'URL "/"
app.get('/', (requete, resultat) => {
  // Ligne 5: On envoie une réponse au client
  resultat.send('Bonjour aux SIO2 SLAM');
});

// Ligne 8: On démarre le serveur pour qu'il écoute sur le port 3000
app.listen(port, () => {
  console.log(`Serveur démarré sur http://localhost:${port}`);
});
----


. *Étape 4 : Exécution*
+
Démarrez le serveur (avec `node routeintro.js` ou via un script `npm`) et allez sur `http://localhost:3000` dans votre navigateur. Vous devriez voir le message "Bonjour aux SIO2 SLAM".

=== Utilitaire de "Hot Reloading" : nodemon

Le package `nodemon` fonctionne parfaitement avec les ES Modules. L'installation et la configuration sont identiques.

. *Étape 1 : Installation*
+
[source,bash]
----
npm install nodemon
----

. *Étape 2 : Ajout d'un script dans `package.json`*
+
[source,json]
----
"scripts": {
  "demarre": "nodemon routeintro.js"
},
----

. *Étape 3 : Lancement*
+
[source,bash]
----
npm run demarre
----
+
Le serveur redémarrera maintenant tout seul à chaque modification.

== Exercices

=== Exercice 1 : Routage simple

Dans votre fichier `routeintro.js`, ajoutez une nouvelle route. Si un utilisateur accède à l'URL `http://localhost:3000/accueil`, il doit recevoir le message "Vous êtes arrivés sur la page d’accueil du site".

=== Exercice 2 : Envoyer un fichier HTML

Le but est de renvoyer une page HTML complète au lieu d'un simple texte.

. Créez un fichier `bienvenue.html` à la racine de votre projet avec un message de bienvenue simple.

. Pour manipuler les chemins de fichiers, il faut importer des modules natifs de NodeJS. En ESM, la variable `__dirname` n'existe pas. On doit la recréer. Ajoutez ces lignes au début de `routeintro.js`:
+
[source,javascript]
----
/** Pour les versions antérieures à Node.js 20

import path from 'path';
import { fileURLToPath } from 'url';
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

*/

// Avec les versions récentes de Node.js, on peut  utiliser :
// Recréation de __dirname pour la compatibilité ESM
const __dirname = import.meta.dirname;
----
+
[NOTE]
====
Ces lignes permettent de retrouver le chemin absolu du répertoire du script en cours d'exécution, ce qui est indispensable pour servir des fichiers de manière fiable.
====

. Ajoutez une route pour le chemin `/bienvenue` qui utilise la méthode `res.sendFile()` pour renvoyer le fichier HTML.

.Aide (structure du fichier `routeintro.js` complet) :
[source,javascript]
----
import express from 'express';
/** Pour les versions antérieures à Node.js 20

import path from 'path';
import { fileURLToPath } from 'url';
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

*/

// Avec les versions récentes de Node.js, on peut  utiliser :
// Recréation de __dirname pour la compatibilité ESM
const __dirname = import.meta.dirname;




const app = express();
const port = 3000;

app.get('/', (requete, resultat) => {
  resultat.send('Bonjour aux SIO2 SLAM');
});

// Solution Exercice 1
app.get('/accueil', (req, res) => {
  res.send('Vous êtes arrivés sur la page d’accueil du site');
});

// Solution Exercice 2
app.get('/bienvenue', (req, res) => {
  res.sendFile(path.join(__dirname, 'bienvenue.html'));
});

app.listen(port, () => {
  console.log(`Serveur démarré sur http://localhost:${port}`);
});
----

=== Exercice 3 : Navigation entre les routes

. Créez une nouvelle route `/panorama` qui renvoie un fichier `planDuSite.html`.
. Dans ce fichier `planDuSite.html`, ajoutez des liens hypertextes (`<a href="...">`) qui pointent vers les autres routes que vous avez créées : `/`, `/accueil` et `/bienvenue`.